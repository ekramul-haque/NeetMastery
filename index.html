<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NEET Mastery | 40 Years of Excellence</title>
    <script src="questions.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;600;700&display=swap" rel="stylesheet">
    
    <style>
        body {
            font-family: 'Outfit', sans-serif;
            background-color: #f0f4f8;
            overflow-x: hidden;
        }

        .bg-mesh {
            background: radial-gradient(at 0% 0%, hsla(192,70%,85%,1) 0, transparent 50%), 
                        radial-gradient(at 50% 0%, hsla(162,70%,85%,1) 0, transparent 50%), 
                        radial-gradient(at 100% 0%, hsla(238,70%,90%,1) 0, transparent 50%);
            background-size: 200% 200%;
            animation: gradient-move 15s ease infinite;
        }

        @keyframes gradient-move {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }

        .hover-card {
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        .hover-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
        }

        .option-btn {
            transition: all 0.2s ease;
        }
        .option-btn.selected {
            border-color: #3b82f6;
            background-color: #eff6ff;
            transform: scale(1.02);
        }
        .option-btn.correct {
            border-color: #22c55e;
            background-color: #dcfce7;
            color: #15803d;
        }
        .option-btn.wrong {
            border-color: #ef4444;
            background-color: #fee2e2;
            color: #b91c1c;
        }

        .fade-in {
            animation: fadeIn 0.5s ease-in-out;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        ::-webkit-scrollbar {
            width: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #f1f1f1; 
        }
        ::-webkit-scrollbar-thumb {
            background: #cbd5e1; 
            border-radius: 4px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #94a3b8; 
        }

        .glass-panel {
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.5);
        }

        .mode-selector {
            transition: all 0.3s ease;
        }
        .mode-selector:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(0,0,0,0.1);
        }
        .mode-selector.selected {
            border-color: #0d9488;
            background-color: #f0fdfa;
            box-shadow: 0 0 0 3px rgba(13, 148, 136, 0.2);
        }

        .filter-btn {
            transition: all 0.2s ease;
        }
        .filter-btn.active {
            background-color: #0d9488;
            color: white;
        }

        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0, 0, 0, 0.7);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 9999;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
        }
        .modal-overlay.active {
            opacity: 1;
            visibility: visible;
        }

        /* Login modal specific - cannot be closed without action */
        #login-modal {
            z-index: 99999 !important;
        }
        #login-modal .modal-content {
            background: white;
            padding: 2rem;
            border-radius: 1rem;
            max-width: 400px;
            width: 90%;
            text-align: center;
            transform: scale(0.9);
            transition: all 0.3s ease;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5);
        }
        #login-modal.active .modal-content {
            transform: scale(1);
        }

        /* Hide main content until logged in */
        body:not(.logged-in) main {
            filter: blur(5px);
            pointer-events: none;
            user-select: none;
        }
        body:not(.logged-in) nav {
            filter: blur(5px);
            pointer-events: none;
        }

        /* BUT login modal should ALWAYS be visible and on top */
        #login-modal {
            pointer-events: auto !important;
        }

        .modal-content {
            background: white;
            padding: 2rem;
            border-radius: 1rem;
            max-width: 400px;
            width: 90%;
            text-align: center;
            transform: scale(0.9);
            transition: all 0.3s ease;
        }
        .modal-overlay.active .modal-content {
            transform: scale(1);
        }
        
        .toast {
            position: fixed;
            bottom: 20px;
            right: 20px;
            padding: 12px 24px;
            border-radius: 8px;
            color: white;
            font-weight: 500;
            z-index: 1000;
            animation: fadeIn 0.3s ease;
        }
        .toast.success { background: #22c55e; }
        .toast.error { background: #ef4444; }
        .toast.info { background: #3b82f6; }
    </style>
</head>
<body class="bg-mesh min-h-screen text-slate-800">

    <!-- Mandatory Login Modal - MUST BE FIRST IN BODY -->
    <div id="login-modal" class="modal-overlay active">
        <div class="modal-content">
            <div class="mb-6">
                <i class="fa-solid fa-user-doctor text-5xl text-teal-600 mb-4"></i>
                <h2 class="text-2xl font-bold text-slate-800 mb-2">Welcome to NEET Mastery</h2>
                <p class="text-slate-600">Create a profile to start your NEET preparation journey</p>
            </div>
            
            <div class="space-y-4 text-left">
                <div>
                    <label class="block text-sm font-medium text-slate-700 mb-1">Your Name *</label>
                    <input type="text" id="new-user-name" placeholder="Enter your full name" 
                        class="w-full px-4 py-3 rounded-lg border border-slate-300 focus:border-teal-500 focus:ring-2 focus:ring-teal-200 outline-none transition">
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-slate-700 mb-1">Email (optional)</label>
                    <input type="email" id="new-user-email" placeholder="For progress backup" 
                        class="w-full px-4 py-3 rounded-lg border border-slate-300 focus:border-teal-500 focus:ring-2 focus:ring-teal-200 outline-none transition">
                </div>
                
                <button onclick="app.createUser()" class="w-full px-4 py-3 rounded-lg bg-teal-600 text-white font-semibold hover:bg-teal-700 transition mt-4">
                    <i class="fa-solid fa-play mr-2"></i>Start Learning
                </button>
            </div>
            
            <div id="existing-users-section" class="mt-6 pt-6 border-t border-slate-200 hidden">
                <p class="text-sm text-slate-500 mb-3">Or select existing profile:</p>
                <div id="existing-users" class="space-y-2 max-h-32 overflow-y-auto"></div>
            </div>
        </div>
    </div>

    <!-- Custom Modal -->
    <div id="custom-modal" class="modal-overlay">
        <div class="modal-content">
            <div class="mb-4">
                <i class="fa-solid fa-circle-exclamation text-5xl text-yellow-500"></i>
            </div>
            <h3 class="text-xl font-bold text-slate-800 mb-2" id="modal-title">Leave Test?</h3>
            <p class="text-slate-600 mb-6" id="modal-message">You are in the middle of a test. Your progress will be lost.</p>
            <div class="flex gap-4 justify-center">
                <button onclick="app.modalCancel()" class="px-6 py-2 rounded-lg border border-slate-300 text-slate-600 hover:bg-slate-50 transition">
                    Stay
                </button>
                <button onclick="app.modalConfirm()" class="px-6 py-2 rounded-lg bg-red-600 text-white hover:bg-red-700 transition">
                    Leave
                </button>
            </div>
        </div>
    </div>

    <!-- Navigation -->
    <nav class="fixed top-0 w-full z-50 glass-panel border-b border-slate-200 shadow-sm">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between h-16 items-center">
                <div class="flex items-center cursor-pointer" onclick="app.checkNavigation('home')">
                    <i class="fa-solid fa-user-doctor text-3xl text-teal-600 mr-3"></i>
                    <span class="font-bold text-2xl tracking-tight text-slate-800">NEET<span class="text-teal-600">Mastery</span></span>
                </div>
                <div class="hidden md:flex space-x-8">
                    <button onclick="app.checkNavigation('home')" class="nav-link text-slate-600 hover:text-teal-600 font-medium transition">Dashboard</button>
                    <button onclick="app.checkNavigation('practice')" class="nav-link text-slate-600 hover:text-teal-600 font-medium transition">Practice</button>
                    <button onclick="app.checkNavigation('wrong')" class="nav-link text-slate-600 hover:text-teal-600 font-medium transition relative">
                        Re-Attempt Wrong
                        <span id="wrong-count-badge" class="absolute -top-2 -right-4 bg-red-500 text-white text-xs rounded-full h-5 w-5 flex items-center justify-center hidden">0</span>
                    </button>
                    <!-- User display (shows after login) -->
                    <div id="nav-user-display" class="hidden flex items-center gap-2 ml-4 pl-4 border-l border-slate-200">
                        <div class="w-8 h-8 rounded-full bg-teal-100 text-teal-600 flex items-center justify-center font-bold text-sm" id="nav-avatar">
                            U
                        </div>
                        <span id="nav-username" class="text-sm font-medium text-slate-700 hidden md:block">User</span>
                        <button onclick="app.logout()" class="ml-2 text-slate-400 hover:text-red-500 text-sm" title="Logout">
                            <i class="fa-solid fa-right-from-bracket"></i>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </nav>

    <main class="pt-20 pb-10 px-4 sm:px-6 lg:px-8 max-w-7xl mx-auto">
        
        <!-- VIEW: DASHBOARD -->
        <div id="view-home" class="fade-in space-y-8">
            <div class="grid grid-cols-1 md:grid-cols-4 gap-6">
                <div class="glass-panel p-6 rounded-2xl shadow-sm hover-card border-l-4 border-teal-500">
                    <div class="flex justify-between items-start">
                        <div>
                            <p class="text-sm font-medium text-slate-500">Total Questions</p>
                            <h3 class="text-3xl font-bold text-slate-800 mt-1" id="total-questions-count">12,450+</h3>
                        </div>
                        <div class="p-2 bg-teal-100 rounded-lg text-teal-600">
                            <i class="fa-solid fa-database"></i>
                        </div>
                    </div>
                    <p class="text-xs text-slate-400 mt-4">NEET, AIIMS & State PMTs</p>
                </div>

                <div class="glass-panel p-6 rounded-2xl shadow-sm hover-card border-l-4 border-blue-500">
                    <div class="flex justify-between items-start">
                        <div>
                            <p class="text-sm font-medium text-slate-500">Your Accuracy</p>
                            <h3 class="text-3xl font-bold text-slate-800 mt-1" id="dash-accuracy">0%</h3>
                        </div>
                        <div class="p-2 bg-blue-100 rounded-lg text-blue-600">
                            <i class="fa-solid fa-bullseye"></i>
                        </div>
                    </div>
                    <p class="text-xs text-slate-400 mt-4">Based on attempted questions</p>
                </div>

                <div class="glass-panel p-6 rounded-2xl shadow-sm hover-card border-l-4 border-purple-500">
                    <div class="flex justify-between items-start">
                        <div>
                            <p class="text-sm font-medium text-slate-500">Syllabus Covered</p>
                            <h3 class="text-3xl font-bold text-slate-800 mt-1" id="dash-syllabus">0%</h3>
                        </div>
                        <div class="p-2 bg-purple-100 rounded-lg text-purple-600">
                            <i class="fa-solid fa-graduation-cap"></i>
                        </div>
                    </div>
                    <p class="text-xs text-slate-400 mt-4">Chapters touched</p>
                </div>

                <div class="glass-panel p-6 rounded-2xl shadow-sm hover-card border-l-4 border-orange-500 cursor-pointer" onclick="app.checkNavigation('wrong')">
                    <div class="flex justify-between items-start">
                        <div>
                            <p class="text-sm font-medium text-slate-500">Weak Areas</p>
                            <h3 class="text-3xl font-bold text-slate-800 mt-1" id="dash-weak">0</h3>
                        </div>
                        <div class="p-2 bg-orange-100 rounded-lg text-orange-600">
                            <i class="fa-solid fa-fire"></i>
                        </div>
                    </div>
                    <p class="text-xs text-slate-400 mt-4">Questions to re-attempt</p>
                </div>
            </div>

            <div class="glass-panel p-8 rounded-2xl shadow-lg">
                <h2 class="text-2xl font-bold text-slate-800 mb-6 flex items-center">
                    <i class="fa-solid fa-chart-pie mr-3 text-teal-600"></i> Subject Mastery
                </h2>
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                    <div class="space-y-4">
                        <div class="flex justify-between items-center mb-2">
                            <h3 class="font-bold text-lg text-slate-700"><i class="fa-solid fa-atom mr-2 text-blue-500"></i>Physics</h3>
                            <span class="text-sm font-semibold text-slate-500" id="phy-score">0% Strong</span>
                        </div>
                        <div class="h-3 w-full bg-slate-200 rounded-full overflow-hidden">
                            <div id="phy-bar" class="h-full bg-blue-500 rounded-full transition-all duration-1000" style="width: 0%"></div>
                        </div>
                        <div id="phy-chapters" class="grid grid-cols-1 gap-2 text-sm"></div>
                    </div>

                    <div class="space-y-4">
                        <div class="flex justify-between items-center mb-2">
                            <h3 class="font-bold text-lg text-slate-700"><i class="fa-solid fa-flask mr-2 text-pink-500"></i>Chemistry</h3>
                            <span class="text-sm font-semibold text-slate-500" id="chem-score">0% Strong</span>
                        </div>
                        <div class="h-3 w-full bg-slate-200 rounded-full overflow-hidden">
                            <div id="chem-bar" class="h-full bg-pink-500 rounded-full transition-all duration-1000" style="width: 0%"></div>
                        </div>
                        <div id="chem-chapters" class="grid grid-cols-1 gap-2 text-sm"></div>
                    </div>

                    <div class="space-y-4">
                        <div class="flex justify-between items-center mb-2">
                            <h3 class="font-bold text-lg text-slate-700"><i class="fa-solid fa-dna mr-2 text-green-500"></i>Biology</h3>
                            <span class="text-sm font-semibold text-slate-500" id="bio-score">0% Strong</span>
                        </div>
                        <div class="h-3 w-full bg-slate-200 rounded-full overflow-hidden">
                            <div id="bio-bar" class="h-full bg-green-500 rounded-full transition-all duration-1000" style="width: 0%"></div>
                        </div>
                        <div id="bio-chapters" class="grid grid-cols-1 gap-2 text-sm"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- VIEW: PRACTICE SELECTION -->
        <div id="view-practice" class="hidden fade-in space-y-8">
            <div class="text-center mb-10">
                <h1 class="text-4xl font-bold text-slate-800 mb-4">Select Practice Mode</h1>
                <p class="text-slate-600 max-w-2xl mx-auto">Choose how you want to practice. Year-wise papers simulate real exam conditions, while Chapter-wise helps you target specific weaknesses.</p>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                <div onclick="app.showYearSelector()" class="glass-panel p-8 rounded-2xl shadow-lg hover-card cursor-pointer group relative overflow-hidden">
                    <div class="absolute top-0 right-0 p-4 opacity-10 group-hover:opacity-20 transition">
                        <i class="fa-solid fa-calendar-days text-9xl"></i>
                    </div>
                    <div class="relative z-10">
                        <div class="w-16 h-16 bg-teal-100 rounded-2xl flex items-center justify-center text-teal-600 text-3xl mb-6 group-hover:scale-110 transition">
                            <i class="fa-solid fa-clock-rotate-left"></i>
                        </div>
                        <h2 class="text-2xl font-bold text-slate-800 mb-2">Year Wise Papers</h2>
                        <p class="text-slate-600 mb-6">Practice full papers from NEET (2013-2024), AIIMS (1994-2020), and State PMTs.</p>
                        <div class="flex items-center text-teal-600 font-semibold">
                            Start Practice <i class="fa-solid fa-arrow-right ml-2 group-hover:translate-x-1 transition"></i>
                        </div>
                    </div>
                </div>

                <div onclick="app.showChapterSelector()" class="glass-panel p-8 rounded-2xl shadow-lg hover-card cursor-pointer group relative overflow-hidden">
                    <div class="absolute top-0 right-0 p-4 opacity-10 group-hover:opacity-20 transition">
                        <i class="fa-solid fa-book-open text-9xl"></i>
                    </div>
                    <div class="relative z-10">
                        <div class="w-16 h-16 bg-purple-100 rounded-2xl flex items-center justify-center text-purple-600 text-3xl mb-6 group-hover:scale-110 transition">
                            <i class="fa-solid fa-layer-group"></i>
                        </div>
                        <h2 class="text-2xl font-bold text-slate-800 mb-2">Chapter Wise (PYQs)</h2>
                        <p class="text-slate-600 mb-6">Target specific chapters from Physics, Chemistry, Botany & Zoology.</p>
                        <div class="flex items-center text-purple-600 font-semibold">
                            Browse Chapters <i class="fa-solid fa-arrow-right ml-2 group-hover:translate-x-1 transition"></i>
                        </div>
                    </div>
                </div>
            </div>

            <div id="year-selector" class="hidden mt-8 glass-panel p-6 rounded-2xl shadow-lg">
                <h3 class="text-xl font-bold mb-4">Select Year & Exam</h3>
                <div class="grid grid-cols-2 sm:grid-cols-4 md:grid-cols-6 gap-4" id="year-grid"></div>
            </div>

            <div id="chapter-selector" class="hidden mt-8 glass-panel p-6 rounded-2xl shadow-lg">
                <div class="flex space-x-4 mb-6 border-b border-slate-200">
                    <button onclick="app.filterChapters('Physics')" class="pb-2 px-4 font-semibold text-blue-600 border-b-2 border-blue-600">Physics</button>
                    <button onclick="app.filterChapters('Chemistry')" class="pb-2 px-4 font-semibold text-slate-500 hover:text-pink-600">Chemistry</button>
                    <button onclick="app.filterChapters('Biology')" class="pb-2 px-4 font-semibold text-slate-500 hover:text-green-600">Biology</button>
                </div>
                <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-4" id="chapter-grid"></div>
            </div>
        </div>

        <!-- VIEW: MODE SELECTION -->
        <div id="view-mode-select" class="hidden fade-in max-w-4xl mx-auto">
            <div class="text-center mb-10">
                <h1 class="text-4xl font-bold text-slate-800 mb-4">Choose Test Mode</h1>
                <p class="text-slate-600">Select how you want to attempt the questions</p>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                <div onclick="app.selectMode('instant')" id="mode-instant" class="mode-selector glass-panel p-8 rounded-2xl shadow-lg cursor-pointer border-2 border-transparent">
                    <div class="w-16 h-16 bg-green-100 rounded-2xl flex items-center justify-center text-green-600 text-3xl mb-6">
                        <i class="fa-solid fa-bolt"></i>
                    </div>
                    <h2 class="text-2xl font-bold text-slate-800 mb-2">Instant Feedback Mode</h2>
                    <ul class="text-slate-600 space-y-2 mb-6">
                        <li class="flex items-center"><i class="fa-solid fa-check text-green-500 mr-2"></i> Know answer immediately</li>
                        <li class="flex items-center"><i class="fa-solid fa-check text-green-500 mr-2"></i> See explanation right away</li>
                        <li class="flex items-center"><i class="fa-solid fa-check text-green-500 mr-2"></i> Must submit before proceeding</li>
                    </ul>
                    <div class="text-green-600 font-semibold">Select This Mode <i class="fa-solid fa-arrow-right ml-2"></i></div>
                </div>

                <div onclick="app.selectMode('test')" id="mode-test" class="mode-selector glass-panel p-8 rounded-2xl shadow-lg cursor-pointer border-2 border-transparent">
                    <div class="w-16 h-16 bg-purple-100 rounded-2xl flex items-center justify-center text-purple-600 text-3xl mb-6">
                        <i class="fa-solid fa-clipboard-check"></i>
                    </div>
                    <h2 class="text-2xl font-bold text-slate-800 mb-2">Test Mode</h2>
                    <ul class="text-slate-600 space-y-2 mb-6">
                        <li class="flex items-center"><i class="fa-solid fa-check text-purple-500 mr-2"></i> Attempt all questions first</li>
                        <li class="flex items-center"><i class="fa-solid fa-check text-purple-500 mr-2"></i> Mark questions for review</li>
                        <li class="flex items-center"><i class="fa-solid fa-check text-purple-500 mr-2"></i> Full analysis at the end</li>
                    </ul>
                    <div class="text-purple-600 font-semibold">Select This Mode <i class="fa-solid fa-arrow-right ml-2"></i></div>
                </div>
            </div>

            <div class="mt-8 text-center">
                <button onclick="app.checkNavigation('practice')" class="text-slate-500 hover:text-slate-700 font-medium">
                    <i class="fa-solid fa-arrow-left mr-2"></i> Back to Selection
                </button>
            </div>
        </div>

        <!-- VIEW: TEST INTERFACE -->
        <div id="view-test" class="hidden fade-in max-w-4xl mx-auto">
            <div class="glass-panel p-4 rounded-xl shadow-sm mb-6 flex flex-wrap justify-between items-center sticky top-20 z-30">
                <div>
                    <h2 id="test-title" class="font-bold text-lg text-slate-800">NEET 2023 - Physics</h2>
                    <div class="flex items-center space-x-4 mt-1">
                        <span class="text-xs font-semibold px-2 py-1 rounded bg-slate-200 text-slate-700" id="test-mode-badge">INSTANT MODE</span>
                        <span class="text-xs text-slate-500" id="test-progress">Q 1 / 45</span>
                    </div>
                </div>
                <div class="flex items-center space-x-4 mt-2 sm:mt-0">
                    <div class="text-right">
                        <div class="text-xs text-slate-500">Time Elapsed</div>
                        <div class="font-mono font-bold text-xl text-slate-800" id="test-timer">00:00</div>
                    </div>
                    <button onclick="app.endTest()" class="bg-red-100 text-red-600 hover:bg-red-200 px-4 py-2 rounded-lg font-semibold text-sm transition">
                        End Test
                    </button>
                </div>
            </div>

            <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                <div class="lg:col-span-2 space-y-6">
                    <div class="glass-panel p-6 rounded-2xl shadow-lg min-h-[400px] flex flex-col justify-between">
                        <div>
                            <div class="flex justify-between items-start mb-4">
                                <span class="bg-slate-100 text-slate-600 text-xs font-bold px-2 py-1 rounded uppercase" id="q-subject">Physics</span>
                                <button onclick="app.toggleMarkReview()" id="btn-mark-review" class="text-slate-400 hover:text-orange-500 transition">
                                    <i class="fa-regular fa-bookmark text-xl"></i>
                                </button>
                            </div>
                            <h3 class="text-lg font-medium text-slate-800 mb-6 leading-relaxed" id="q-text">
                                Loading Question...
                            </h3>
                            
                            <div class="space-y-3" id="q-options"></div>
                        </div>

                        <div id="instant-feedback" class="hidden mt-6 pt-6 border-t border-slate-200 animate-fade-in">
                            <div class="flex items-center mb-2" id="feedback-header"></div>
                            <div class="bg-slate-50 p-4 rounded-lg text-sm text-slate-700">
                                <span class="font-bold text-slate-900">Explanation:</span>
                                <p id="q-explanation" class="mt-1">Explanation text goes here.</p>
                            </div>
                        </div>

                        <div class="mt-6 flex justify-between items-center" id="nav-buttons">
                            <!-- Navigation buttons will be inserted here by JavaScript -->
                        </div>
                    </div>
                </div>

                <div class="space-y-6">
                    <div class="glass-panel p-4 rounded-xl shadow-sm bg-blue-50 border border-blue-100">
                        <h4 class="font-bold text-blue-800 mb-2 text-sm"><i class="fa-solid fa-circle-info mr-1"></i> Current Mode</h4>
                        <p class="text-xs text-blue-700 mb-3" id="mode-desc">Instantly know if you are right or wrong.</p>
                    </div>

                    <div class="glass-panel p-4 rounded-xl shadow-sm">
                        <h4 class="font-bold text-slate-700 mb-3 text-sm">Question Palette</h4>
                        <div class="grid grid-cols-5 gap-2" id="q-palette"></div>
                        <div class="mt-4 flex flex-wrap gap-2 text-xs">
                            <div class="flex items-center"><div class="w-3 h-3 rounded-full bg-slate-200 mr-1"></div> Not Visited</div>
                            <div class="flex items-center"><div class="w-3 h-3 rounded-full bg-blue-500 mr-1"></div> Answered</div>
                            <div class="flex items-center"><div class="w-3 h-3 rounded-full bg-orange-400 mr-1"></div> Marked</div>
                        </div>
                    </div>

                    <button id="btn-submit-test" onclick="app.submitTest()" class="hidden w-full bg-slate-800 hover:bg-slate-900 text-white py-3 rounded-xl font-bold transition shadow-lg">
                        Submit Test
                    </button>
                </div>
            </div>
        </div>

        <!-- VIEW: ANALYSIS / RESULT -->
        <div id="view-analysis" class="hidden fade-in max-w-5xl mx-auto space-y-8">
            <div class="text-center mb-8">
                <h1 class="text-3xl font-bold text-slate-800">Test Analysis</h1>
                <p class="text-slate-600">Review your performance and solutions</p>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                <div class="glass-panel p-6 rounded-2xl text-center border-t-4 border-green-500">
                    <h3 class="text-slate-500 font-medium">Correct</h3>
                    <p class="text-4xl font-bold text-green-600 my-2" id="res-correct">0</p>
                    <p class="text-sm text-slate-400">+ <span id="res-pos-marks">0</span> Marks</p>
                </div>
                <div class="glass-panel p-6 rounded-2xl text-center border-t-4 border-red-500">
                    <h3 class="text-slate-500 font-medium">Incorrect</h3>
                    <p class="text-4xl font-bold text-red-600 my-2" id="res-wrong">0</p>
                    <p class="text-sm text-slate-400">- <span id="res-neg-marks">0</span> Marks</p>
                </div>
                <div class="glass-panel p-6 rounded-2xl text-center border-t-4 border-blue-500">
                    <h3 class="text-slate-500 font-medium">Total Score</h3>
                    <p class="text-4xl font-bold text-blue-600 my-2" id="res-score">0</p>
                    <p class="text-sm text-slate-400">Out of <span id="res-total">0</span></p>
                </div>
            </div>

            <div class="glass-panel p-6 rounded-xl shadow-lg">
                <div class="flex flex-wrap gap-4 mb-4">
                    <div class="flex items-center space-x-2">
                        <span class="text-sm font-bold text-slate-600">Filter:</span>
                        <button onclick="app.filterAnalysis('all')" class="filter-btn active px-4 py-2 rounded-lg text-sm font-medium bg-slate-200 text-slate-700 hover:bg-slate-300 transition" data-filter="all">All</button>
                        <button onclick="app.filterAnalysis('correct')" class="filter-btn px-4 py-2 rounded-lg text-sm font-medium bg-slate-200 text-slate-700 hover:bg-slate-300 transition" data-filter="correct">Correct</button>
                        <button onclick="app.filterAnalysis('wrong')" class="filter-btn px-4 py-2 rounded-lg text-sm font-medium bg-slate-200 text-slate-700 hover:bg-slate-300 transition" data-filter="wrong">Wrong</button>
                        <button onclick="app.filterAnalysis('skipped')" class="filter-btn px-4 py-2 rounded-lg text-sm font-medium bg-slate-200 text-slate-700 hover:bg-slate-300 transition" data-filter="skipped">Skipped</button>
                        <button onclick="app.filterAnalysis('marked')" class="filter-btn px-4 py-2 rounded-lg text-sm font-medium bg-slate-200 text-slate-700 hover:bg-slate-300 transition" data-filter="marked">Marked</button>
                    </div>
                </div>
                <div class="flex flex-wrap gap-4">
                    <div class="flex items-center space-x-2">
                        <span class="text-sm font-bold text-slate-600">Subject:</span>
                        <button onclick="app.filterSubject('all')" class="subject-filter active px-4 py-2 rounded-lg text-sm font-medium bg-slate-200 text-slate-700 hover:bg-slate-300 transition" data-subject="all">All</button>
                        <button onclick="app.filterSubject('Physics')" class="subject-filter px-4 py-2 rounded-lg text-sm font-medium bg-slate-200 text-slate-700 hover:bg-slate-300 transition" data-subject="Physics">Physics</button>
                        <button onclick="app.filterSubject('Chemistry')" class="subject-filter px-4 py-2 rounded-lg text-sm font-medium bg-slate-200 text-slate-700 hover:bg-slate-300 transition" data-subject="Chemistry">Chemistry</button>
                        <button onclick="app.filterSubject('Biology')" class="subject-filter px-4 py-2 rounded-lg text-sm font-medium bg-slate-200 text-slate-700 hover:bg-slate-300 transition" data-subject="Biology">Biology</button>
                    </div>
                </div>
            </div>

            <div class="glass-panel p-8 rounded-2xl shadow-lg">
                <h2 class="text-xl font-bold mb-6">Detailed Solutions</h2>
                <div id="analysis-list" class="space-y-6"></div>
            </div>
            
            <div class="flex justify-center pb-10">
                <button onclick="app.navigate('home')" class="bg-teal-600 hover:bg-teal-700 text-white px-8 py-3 rounded-xl font-bold transition shadow-lg">
                    Back to Dashboard
                </button>
            </div>
        </div>

        <!-- VIEW: WRONG ATTEMPTS -->
        <div id="view-wrong" class="hidden fade-in max-w-5xl mx-auto">
            <div class="flex justify-between items-center mb-8">
                <div>
                    <h1 class="text-3xl font-bold text-slate-800">Re-Attempt Wrong Questions</h1>
                    <p class="text-slate-600">Master your mistakes. Solutions are locked until you attempt again.</p>
                </div>
                <div class="bg-red-100 text-red-700 px-4 py-2 rounded-lg font-bold">
                    <i class="fa-solid fa-triangle-exclamation mr-2"></i> <span id="wrong-total-count">0</span> Pending
                </div>
            </div>

            <div id="wrong-list" class="space-y-4"></div>
        </div>

    </main>

    <script>
        // questionDatabase is loaded from questions.js file

        // Extract unique chapters from database
        const chapters = {};
        if (typeof questionDatabase !== 'undefined') {
            questionDatabase.forEach(q => {
                if (!chapters[q.subject]) chapters[q.subject] = [];
                if (!chapters[q.subject].includes(q.chapter)) {
                    chapters[q.subject].push(q.chapter);
                }
            });
        }

        // ==========================================
        // APPLICATION STATE & LOGIC
        // ==========================================

        const appState = {
            currentView: 'home',
            userStats: {
                totalAttempted: 0,
                totalCorrect: 0,
                wrongAttempts: [],
                chapterProgress: {}
            },
            activeTest: {
                questions: [],
                currentIndex: 0,
                answers: {},
                marked: [],
                mode: 'instant',
                startTime: null,
                timerInterval: null,
                submittedAnswers: {},
                tempAnswer: null
            },
            analysisFilter: {
                status: 'all',
                subject: 'all'
            },
            pendingNavigation: null,
            modalCallback: null
        };

        const app = {
            currentUser: null,
            
            init: () => {
                const savedUser = localStorage.getItem('neetCurrentUser');
                if (savedUser) {
                    // User exists - hide modal, show site
                    app.currentUser = JSON.parse(savedUser);
                    document.getElementById('login-modal').classList.remove('active');
                    document.body.classList.add('logged-in');
                    app.showUserProfile();
                    app.loadUserStats();
                } else {
                    // New user - show mandatory login modal
                    document.getElementById('login-modal').classList.add('active');
                    document.body.classList.remove('logged-in');
                    app.renderExistingUsers();
                }
                app.renderDashboard();
                app.updateWrongBadge();
                app.updateTotalQuestionsCount();
            },

            updateTotalQuestionsCount: () => {
                const count = typeof questionDatabase !== 'undefined' ? questionDatabase.length : 0;
                document.getElementById('total-questions-count').innerText = count.toLocaleString() + '+';
            },

            showModal: (title, message, onConfirm) => {
                document.getElementById('modal-title').innerText = title;
                document.getElementById('modal-message').innerText = message;
                appState.modalCallback = onConfirm;
                document.getElementById('custom-modal').classList.add('active');
            },

            modalConfirm: () => {
                document.getElementById('custom-modal').classList.remove('active');
                if (appState.modalCallback) {
                    appState.modalCallback();
                    appState.modalCallback = null;
                }
            },

            modalCancel: () => {
                document.getElementById('custom-modal').classList.remove('active');
                appState.modalCallback = null;
            },

            checkNavigation: (viewId) => {
                if (appState.currentView === 'test') {
                    appState.pendingNavigation = viewId;
                    app.showModal(
                        'Leave Test?',
                        'You are in the middle of a test. Your progress will be lost.',
                        () => {
                            if (appState.activeTest.mode === 'test') {
                                app.submitTestOnLeave();
                            } else {
                                app.clearTestAndNavigate();
                            }
                        }
                    );
                } else {
                    app.navigate(viewId);
                }
            },

            clearTestAndNavigate: () => {
                clearInterval(appState.activeTest.timerInterval);
                app.navigate(appState.pendingNavigation);
            },

            submitTestOnLeave: () => {
                clearInterval(appState.activeTest.timerInterval);
                
                appState.activeTest.questions.forEach((q, idx) => {
                    const ans = appState.activeTest.answers[idx];
                    if(ans !== undefined && ans !== null) {
                        appState.userStats.totalAttempted++;
                        const isCorrect = ans === q.correct;
                        if(isCorrect) {
                            appState.userStats.totalCorrect++;
                        } else {
                            if(!appState.userStats.wrongAttempts.find(w => w.id === q.id)) {
                                appState.userStats.wrongAttempts.push({...q, userChoice: ans});
                            }
                        }
                        const chapKey = `${q.subject}-${q.chapter}`;
                        if(!appState.userStats.chapterProgress[chapKey]) appState.userStats.chapterProgress[chapKey] = {correct: 0, total: 0};
                        appState.userStats.chapterProgress[chapKey].total++;
                        if(isCorrect) appState.userStats.chapterProgress[chapKey].correct++;
                    }
                });
                app.saveStats();
                app.showAnalysis();
            },

            navigate: (viewId) => {
                document.querySelectorAll('[id^="view-"]').forEach(el => el.classList.add('hidden'));
                document.getElementById(`view-${viewId}`).classList.remove('hidden');
                appState.currentView = viewId;
                
                if(viewId === 'home') app.renderDashboard();
                if(viewId === 'practice') app.resetPracticeView();
                if(viewId === 'wrong') app.renderWrongAttempts();
            },

            loadUserStats: () => {
                if (!app.currentUser) return;
                
                const userStatsKey = `neetStats_${app.currentUser.id}`;
                const saved = localStorage.getItem(userStatsKey);
                
                if (saved) {
                    appState.userStats = JSON.parse(saved);
                } else {
                    appState.userStats = {
                        totalAttempted: 0,
                        totalCorrect: 0,
                        wrongAttempts: [],
                        chapterProgress: {}
                    };
                }
                
                app.renderDashboard();
            },

            saveStats: () => {
                if (app.currentUser) {
                    const userStatsKey = `neetStats_${app.currentUser.id}`;
                    localStorage.setItem(userStatsKey, JSON.stringify(appState.userStats));
                }
                localStorage.setItem('neetAppStats', JSON.stringify(appState.userStats));
                app.updateWrongBadge();
            },

            renderDashboard: () => {
                const stats = appState.userStats;
                const accuracy = stats.totalAttempted > 0 ? Math.round((stats.totalCorrect / stats.totalAttempted) * 100) : 0;
                
                document.getElementById('dash-accuracy').innerText = `${accuracy}%`;
                document.getElementById('dash-weak').innerText = stats.wrongAttempts.length;
                
                const coveredChapters = Object.keys(stats.chapterProgress).length;
                const totalChapters = Object.values(chapters).reduce((a, b) => a + b.length, 0);
                const syllabusPercent = totalChapters > 0 ? Math.min(100, Math.round((coveredChapters / totalChapters) * 100)) : 0;
                document.getElementById('dash-syllabus').innerText = `${syllabusPercent}%`;

                app.renderSubjectCard('Physics', 'phy');
                app.renderSubjectCard('Chemistry', 'chem');
                app.renderSubjectCard('Biology', 'bio');
            },

            renderSubjectCard: (subject, prefix) => {
                const progress = appState.userStats.chapterProgress;
                let correct = 0, total = 0;
                let chapterHtml = '';

                const subChaps = Object.keys(progress).filter(k => k.startsWith(subject));
                
                if(subChaps.length === 0) {
                    document.getElementById(`${prefix}-score`).innerText = "Start Practicing";
                    document.getElementById(`${prefix}-bar`).style.width = "0%";
                    document.getElementById(`${prefix}-chapters`).innerHTML = '<p class="text-slate-400 italic text-xs">No data yet</p>';
                    return;
                }

                subChaps.forEach(chapKey => {
                    const data = progress[chapKey];
                    total += data.total;
                    correct += data.correct;
                    
                    let colorClass = 'bg-red-100 text-red-700 border-red-200';
                    const ratio = data.correct / data.total;
                    if(ratio > 0.8) colorClass = 'bg-green-100 text-green-700 border-green-200';
                    else if(ratio > 0.5) colorClass = 'bg-orange-100 text-orange-700 border-orange-200';

                    const chapName = chapKey.split('-')[1];
                    chapterHtml += `
                        <div class="flex justify-between items-center p-2 rounded border ${colorClass}">
                            <span class="truncate">${chapName}</span>
                            <span class="font-bold text-xs">${Math.round(ratio*100)}%</span>
                        </div>
                    `;
                });

                const pct = total > 0 ? Math.round((correct/total)*100) : 0;
                document.getElementById(`${prefix}-score`).innerText = `${pct}% Accuracy`;
                document.getElementById(`${prefix}-bar`).style.width = `${pct}%`;
                document.getElementById(`${prefix}-chapters`).innerHTML = chapterHtml;
            },

            resetPracticeView: () => {
                document.getElementById('year-selector').classList.add('hidden');
                document.getElementById('chapter-selector').classList.add('hidden');
            },

            showYearSelector: () => {
                const grid = document.getElementById('year-grid');
                grid.innerHTML = '';
                
                // Get unique years from database
                const years = typeof questionDatabase !== 'undefined' 
                    ? [...new Set(questionDatabase.map(q => q.year))].sort((a, b) => b - a)
                    : [];
                
                if (years.length === 0) {
                    grid.innerHTML = '<p class="col-span-full text-center text-slate-500">No year-wise data available</p>';
                } else {
                    years.forEach(year => {
                        grid.innerHTML += `
                            <button onclick="app.prepareTest('year', '${year}')" class="p-3 bg-white border border-slate-200 rounded-lg hover:bg-teal-50 hover:border-teal-500 transition font-semibold text-slate-700 shadow-sm">
                                ${year}
                            </button>
                        `;
                    });
                }
                document.getElementById('year-selector').classList.remove('hidden');
                document.getElementById('chapter-selector').classList.add('hidden');
            },

            showChapterSelector: () => {
                app.filterChapters('Physics');
                document.getElementById('chapter-selector').classList.remove('hidden');
                document.getElementById('year-selector').classList.add('hidden');
            },

            filterChapters: (subject) => {
                const tabs = document.querySelectorAll('#chapter-selector button');
                tabs.forEach(t => {
                    if(t.innerText.includes(subject)) {
                        t.classList.remove('text-slate-500');
                        t.classList.add('text-blue-600', 'border-b-2', 'border-blue-600');
                    } else {
                        t.className = 'pb-2 px-4 font-semibold text-slate-500 hover:text-pink-600';
                    }
                });

                const grid = document.getElementById('chapter-grid');
                grid.innerHTML = '';
                
                const subjectChapters = chapters[subject] || [];
                
                if (subjectChapters.length === 0) {
                    grid.innerHTML = '<p class="col-span-full text-center text-slate-500">No chapters available</p>';
                } else {
                    subjectChapters.forEach(chap => {
                        const count = typeof questionDatabase !== 'undefined' 
                            ? questionDatabase.filter(q => q.subject === subject && q.chapter === chap).length 
                            : 0;
                        grid.innerHTML += `
                            <button onclick="app.prepareTest('chapter', '${subject}-${chap}')" class="flex items-center justify-between p-4 bg-white border border-slate-200 rounded-xl hover:shadow-md hover:border-purple-500 transition group">
                                <div>
                                    <span class="font-medium text-slate-700 block">${chap}</span>
                                    <span class="text-xs text-slate-400">${count} questions</span>
                                </div>
                                <i class="fa-solid fa-chevron-right text-slate-300 group-hover:text-purple-500"></i>
                            </button>
                        `;
                    });
                }
            },

            prepareTest: (type, identifier) => {
                appState.pendingTest = { type, identifier };
                app.navigate('mode-select');
            },

            selectMode: (mode) => {
                document.querySelectorAll('.mode-selector').forEach(el => el.classList.remove('selected'));
                document.getElementById(`mode-${mode}`).classList.add('selected');
                
                setTimeout(() => {
                    app.startTest(appState.pendingTest.type, appState.pendingTest.identifier, mode);
                }, 300);
            },

            startTest: (type, identifier, mode) => {
                let questions = [];
                if(type === 'year') {
                    questions = typeof questionDatabase !== 'undefined' 
                        ? questionDatabase.filter(q => q.year === identifier)
                        : [];
                } else {
                    const [sub, chap] = identifier.split('-');
                    questions = typeof questionDatabase !== 'undefined'
                        ? questionDatabase.filter(q => q.subject === sub && q.chapter === chap)
                        : [];
                }

                if(questions.length === 0) {
                    alert('No questions found for this selection!');
                    app.navigate('practice');
                    return;
                }

                // Shuffle questions for variety
                questions = questions.sort(() => Math.random() - 0.5);

                appState.activeTest = {
                    questions: questions,
                    currentIndex: 0,
                    answers: {},
                    marked: [],
                    mode: mode,
                    startTime: Date.now(),
                    submittedAnswers: {},
                    tempAnswer: null
                };

                document.getElementById('test-title').innerText = `${identifier} - ${questions[0]?.subject || 'Mixed'}`;
                document.getElementById('test-mode-badge').innerText = mode === 'instant' ? 'INSTANT FEEDBACK' : 'TEST MODE';
                document.getElementById('test-mode-badge').className = mode === 'instant' ? 
                    "text-xs font-semibold px-2 py-1 rounded bg-green-100 text-green-700" : 
                    "text-xs font-semibold px-2 py-1 rounded bg-purple-100 text-purple-700";
                
                document.getElementById('mode-desc').innerText = mode === 'instant' ? 
                    "Submit answer to see instant feedback." : 
                    "Attempt all questions, submit at end to see results.";

                document.getElementById('btn-submit-test').classList.toggle('hidden', mode === 'instant');

                if(appState.activeTest.timerInterval) clearInterval(appState.activeTest.timerInterval);
                appState.activeTest.timerInterval = setInterval(() => {
                    const delta = Math.floor((Date.now() - appState.activeTest.startTime) / 1000);
                    const m = Math.floor(delta / 60).toString().padStart(2, '0');
                    const s = (delta % 60).toString().padStart(2, '0');
                    document.getElementById('test-timer').innerText = `${m}:${s}`;
                }, 1000);

                app.navigate('test');
                app.renderQuestion();
                app.renderPalette();
            },

            renderQuestion: () => {
                const test = appState.activeTest;
                const q = test.questions[test.currentIndex];
                
                if (!q) return;
                
                document.getElementById('test-progress').innerText = `Q ${test.currentIndex + 1} / ${test.questions.length}`;
                document.getElementById('q-subject').innerText = `${q.subject}  ${q.chapter}`;
                document.getElementById('q-text').innerText = `${test.currentIndex + 1}. ${q.text}`;
                
                const isMarked = test.marked.includes(test.currentIndex);
                const bookmarkBtn = document.getElementById('btn-mark-review');
                bookmarkBtn.innerHTML = isMarked ? '<i class="fa-solid fa-bookmark text-xl text-orange-500"></i>' : '<i class="fa-regular fa-bookmark text-xl"></i>';

                const optionsDiv = document.getElementById('q-options');
                optionsDiv.innerHTML = '';
                
                const submitted = test.submittedAnswers[test.currentIndex];
                const isInstant = test.mode === 'instant';

                const savedAnswer = test.answers[test.currentIndex];
                const currentSelection = submitted !== undefined ? savedAnswer : test.tempAnswer;

                q.options.forEach((opt, idx) => {
                    const btn = document.createElement('button');
                    btn.className = `option-btn w-full text-left p-4 rounded-xl border-2 border-slate-200 font-medium text-slate-700 flex items-center group`;
                    
                    if(submitted !== undefined) {
                        if(idx === q.correct) btn.classList.add('correct');
                        else if(savedAnswer === idx && idx !== q.correct) btn.classList.add('wrong');
                        btn.disabled = true;
                        btn.classList.add('cursor-not-allowed');
                    } else {
                        if(currentSelection === idx) btn.classList.add('selected', 'border-blue-500', 'bg-blue-50');
                        else btn.classList.add('hover:border-blue-300');
                        btn.onclick = () => app.selectOption(idx);
                    }

                    btn.innerHTML = `
                        <div class="w-8 h-8 rounded-full bg-slate-100 text-slate-500 flex items-center justify-center mr-3 font-bold text-sm transition ${currentSelection === idx ? 'bg-blue-200 text-blue-700' : ''}">${String.fromCharCode(65+idx)}</div>
                        ${opt}
                    `;
                    optionsDiv.appendChild(btn);
                });

                const feedbackDiv = document.getElementById('instant-feedback');
                if(submitted !== undefined && isInstant) {
                    feedbackDiv.classList.remove('hidden');
                    const isCorrect = savedAnswer === q.correct;
                    document.getElementById('feedback-header').innerHTML = isCorrect ? 
                        `<i class="fa-solid fa-circle-check text-green-500 text-2xl mr-2"></i> <span class="font-bold text-green-700">Correct!</span>` : 
                        `<i class="fa-solid fa-circle-xmark text-red-500 text-2xl mr-2"></i> <span class="font-bold text-red-700">Incorrect</span>`;
                    document.getElementById('q-explanation').innerText = q.explanation;
                } else {
                    feedbackDiv.classList.add('hidden');
                }

                app.renderNavigationButtons(submitted, isInstant);
                app.updatePalette();
            },

            renderNavigationButtons: (submitted, isInstant) => {
                const test = appState.activeTest;
                const navDiv = document.getElementById('nav-buttons');
                navDiv.innerHTML = '';

                const prevBtn = document.createElement('button');
                prevBtn.onclick = app.prevQuestion;
                prevBtn.className = 'px-6 py-2 rounded-lg border border-slate-300 text-slate-600 hover:bg-slate-50 transition disabled:opacity-50 disabled:cursor-not-allowed';
                prevBtn.innerHTML = '<i class="fa-solid fa-arrow-left mr-2"></i> Previous';
                prevBtn.disabled = test.currentIndex === 0;

                if (isInstant) {
                    if (submitted === undefined) {
                        const submitBtn = document.createElement('button');
                        submitBtn.onclick = app.submitAnswer;
                        submitBtn.className = 'bg-teal-600 hover:bg-teal-700 text-white px-8 py-2 rounded-lg font-semibold transition shadow-md';
                        submitBtn.innerText = 'Submit Answer';
                        navDiv.appendChild(prevBtn);
                        navDiv.appendChild(submitBtn);
                    } else {
                        const nextAfterSubmit = document.createElement('button');
                        nextAfterSubmit.onclick = app.nextQuestion;
                        nextAfterSubmit.className = 'px-6 py-2 rounded-lg bg-slate-800 text-white hover:bg-slate-900 transition disabled:opacity-50 disabled:cursor-not-allowed';
                        nextAfterSubmit.innerHTML = 'Next <i class="fa-solid fa-arrow-right ml-2"></i>';
                        nextAfterSubmit.disabled = test.currentIndex === test.questions.length - 1;
                        navDiv.appendChild(prevBtn);
                        navDiv.appendChild(nextAfterSubmit);
                    }
                } else {
                    const nextBtn = document.createElement('button');
                    nextBtn.onclick = app.nextQuestion;
                    nextBtn.className = 'px-6 py-2 rounded-lg bg-slate-800 text-white hover:bg-slate-900 transition disabled:opacity-50 disabled:cursor-not-allowed';
                    nextBtn.innerHTML = 'Next <i class="fa-solid fa-arrow-right ml-2"></i>';
                    nextBtn.disabled = test.currentIndex === test.questions.length - 1;
                    navDiv.appendChild(prevBtn);
                    navDiv.appendChild(nextBtn);
                }
            },

            selectOption: (idx) => {
                const test = appState.activeTest;
                test.tempAnswer = idx;
                
                if (test.mode === 'test') {
                    test.answers[test.currentIndex] = idx;
                }
                
                app.renderQuestion();
            },

            submitAnswer: () => {
                const test = appState.activeTest;
                const q = test.questions[test.currentIndex];
                const selected = test.tempAnswer;

                if(selected === null || selected === undefined) {
                    alert('Please select an answer first');
                    return;
                }

                test.answers[test.currentIndex] = selected;
                test.submittedAnswers[test.currentIndex] = true;

                const isCorrect = selected === q.correct;
                appState.userStats.totalAttempted++;
                if(isCorrect) {
                    appState.userStats.totalCorrect++;
                } else {
                    if(!appState.userStats.wrongAttempts.find(w => w.id === q.id)) {
                        appState.userStats.wrongAttempts.push({...q, userChoice: selected});
                    }
                }
                const chapKey = `${q.subject}-${q.chapter}`;
                if(!appState.userStats.chapterProgress[chapKey]) appState.userStats.chapterProgress[chapKey] = {correct: 0, total: 0};
                appState.userStats.chapterProgress[chapKey].total++;
                if(isCorrect) appState.userStats.chapterProgress[chapKey].correct++;

                app.saveStats();
                app.renderQuestion();
            },

            prevQuestion: () => {
                if(appState.activeTest.currentIndex > 0) {
                    appState.activeTest.currentIndex--;
                    const saved = appState.activeTest.answers[appState.activeTest.currentIndex];
                    appState.activeTest.tempAnswer = saved !== undefined ? saved : null;
                    app.renderQuestion();
                }
            },

            nextQuestion: () => {
                if(appState.activeTest.currentIndex < appState.activeTest.questions.length - 1) {
                    appState.activeTest.currentIndex++;
                    const saved = appState.activeTest.answers[appState.activeTest.currentIndex];
                    appState.activeTest.tempAnswer = saved !== undefined ? saved : null;
                    app.renderQuestion();
                }
            },

            toggleMarkReview: () => {
                const idx = appState.activeTest.currentIndex;
                const marked = appState.activeTest.marked;
                if(marked.includes(idx)) {
                    marked.splice(marked.indexOf(idx), 1);
                } else {
                    marked.push(idx);
                }
                app.renderQuestion();
            },

            renderPalette: () => {
                const container = document.getElementById('q-palette');
                container.innerHTML = '';
                const total = appState.activeTest.questions.length;
                
                for(let i=0; i<total; i++) {
                    const btn = document.createElement('button');
                    btn.innerText = i+1;
                    btn.className = "h-8 w-8 rounded text-xs font-bold transition border border-slate-200";
                    btn.onclick = () => {
                        appState.activeTest.currentIndex = i;
                        const saved = appState.activeTest.answers[i];
                        appState.activeTest.tempAnswer = saved !== undefined ? saved : null;
                        app.renderQuestion();
                    };
                    container.appendChild(btn);
                }
                app.updatePalette();
            },

            updatePalette: () => {
                const btns = document.getElementById('q-palette').children;
                const test = appState.activeTest;
                
                for(let i=0; i<btns.length; i++) {
                    btns[i].className = "h-8 w-8 rounded text-xs font-bold transition border border-slate-200";
                    
                    if(test.answers[i] !== undefined) {
                        btns[i].classList.add('bg-blue-500', 'text-white', 'border-blue-500');
                    } else if (test.marked.includes(i)) {
                        btns[i].classList.add('bg-orange-400', 'text-white', 'border-orange-400');
                    } else {
                        btns[i].classList.add('bg-slate-100', 'text-slate-600');
                    }

                    if(i === test.currentIndex) {
                        btns[i].classList.add('ring-2', 'ring-offset-1', 'ring-slate-400');
                    }
                }
            },

            submitTest: () => {
                app.showModal(
                    'Submit Test?',
                    'Are you sure you want to submit the test? You cannot change your answers after submission.',
                    () => {
                        app.endTest();
                    }
                );
            },

            endTest: () => {
                clearInterval(appState.activeTest.timerInterval);
                
                if(appState.activeTest.mode === 'test') {
                    appState.activeTest.questions.forEach((q, idx) => {
                        const ans = appState.activeTest.answers[idx];
                        if(ans !== undefined && ans !== null) {
                            appState.userStats.totalAttempted++;
                            const isCorrect = ans === q.correct;
                            if(isCorrect) {
                                appState.userStats.totalCorrect++;
                            } else {
                                if(!appState.userStats.wrongAttempts.find(w => w.id === q.id)) {
                                    appState.userStats.wrongAttempts.push({...q, userChoice: ans});
                                }
                            }
                            const chapKey = `${q.subject}-${q.chapter}`;
                            if(!appState.userStats.chapterProgress[chapKey]) appState.userStats.chapterProgress[chapKey] = {correct: 0, total: 0};
                            appState.userStats.chapterProgress[chapKey].total++;
                            if(isCorrect) appState.userStats.chapterProgress[chapKey].correct++;
                        }
                    });
                    app.saveStats();
                }

                app.showAnalysis();
            },

            showAnalysis: () => {
                app.navigate('analysis');
                appState.analysisFilter = { status: 'all', subject: 'all' };
                app.renderAnalysis();
            },

            renderAnalysis: () => {
                const test = appState.activeTest;
                let correct = 0, wrong = 0, score = 0, totalMarks = test.questions.length * 4;

                test.questions.forEach((q, idx) => {
                    const ans = test.answers[idx];
                    if(ans !== undefined && ans !== null) {
                        if(ans === q.correct) {
                            correct++;
                            score += 4;
                        } else {
                            wrong++;
                            score -= 1;
                        }
                    }
                });

                document.getElementById('res-correct').innerText = correct;
                document.getElementById('res-pos-marks').innerText = correct * 4;
                document.getElementById('res-wrong').innerText = wrong;
                document.getElementById('res-neg-marks').innerText = wrong * 1;
                document.getElementById('res-score').innerText = score;
                document.getElementById('res-total').innerText = totalMarks;

                app.filterAnalysisUI();
            },

            filterAnalysis: (status) => {
                appState.analysisFilter.status = status;
                document.querySelectorAll('.filter-btn').forEach(btn => {
                    if(btn.dataset.filter === status) btn.classList.add('active');
                    else btn.classList.remove('active');
                });
                app.filterAnalysisUI();
            },

            filterSubject: (subject) => {
                appState.analysisFilter.subject = subject;
                document.querySelectorAll('.subject-filter').forEach(btn => {
                    if(btn.dataset.subject === subject) btn.classList.add('active');
                    else btn.classList.remove('active');
                });
                app.filterAnalysisUI();
            },

            filterAnalysisUI: () => {
                const test = appState.activeTest;
                const list = document.getElementById('analysis-list');
                list.innerHTML = '';

                test.questions.forEach((q, idx) => {
                    const ans = test.answers[idx];
                    let status = 'skipped';
                    if(ans !== undefined) {
                        status = ans === q.correct ? 'correct' : 'wrong';
                    }
                    if(test.marked.includes(idx) && status === 'skipped') status = 'marked';

                    if(appState.analysisFilter.status !== 'all' && status !== appState.analysisFilter.status) return;
                    if(appState.analysisFilter.subject !== 'all' && q.subject !== appState.analysisFilter.subject) return;

                    const statusColor = status === 'skipped' ? 'text-slate-400' : (status === 'correct' ? 'text-green-600' : (status === 'marked' ? 'text-orange-500' : 'text-red-600'));
                    const statusIcon = status === 'skipped' ? 'fa-minus-circle' : (status === 'correct' ? 'fa-check-circle' : (status === 'marked' ? 'fa-bookmark' : 'fa-times-circle'));
                    
                    const userAnsText = ans === undefined ? "Skipped" : q.options[ans];
                    const correctAnsText = q.options[q.correct];

                    list.innerHTML += `
                        <div class="border-b border-slate-100 pb-6 last:border-0">
                            <div class="flex items-start mb-2">
                                <i class="fa-solid ${statusIcon} ${statusColor} mt-1 mr-2 text-lg"></i>
                                <h4 class="font-medium text-slate-800">${idx+1}. ${q.text}</h4>
                            </div>
                            <div class="ml-8 grid grid-cols-1 md:grid-cols-2 gap-4 text-sm bg-slate-50 p-4 rounded-lg">
                                <div>
                                    <span class="text-slate-500 block text-xs uppercase font-bold">Your Answer</span>
                                    <span class="${ans === undefined ? 'text-slate-400 italic' : (status === 'correct' ? 'text-green-700 font-bold' : 'text-red-700 line-through')}">${userAnsText}</span>
                                </div>
                                <div>
                                    <span class="text-slate-500 block text-xs uppercase font-bold">Correct Answer</span>
                                    <span class="text-green-700 font-bold">${correctAnsText}</span>
                                </div>
                                <div class="md:col-span-2 mt-2 pt-2 border-t border-slate-200">
                                    <span class="text-slate-500 block text-xs uppercase font-bold mb-1">Explanation</span>
                                    <p class="text-slate-700">${q.explanation}</p>
                                </div>
                            </div>
                        </div>
                    `;
                });
            },

            updateWrongBadge: () => {
                const count = appState.userStats.wrongAttempts.length;
                const badge = document.getElementById('wrong-count-badge');
                if(count > 0) {
                    badge.innerText = count;
                    badge.classList.remove('hidden');
                } else {
                    badge.classList.add('hidden');
                }
            },

            renderWrongAttempts: () => {
                const container = document.getElementById('wrong-list');
                const wrongs = appState.userStats.wrongAttempts;
                document.getElementById('wrong-total-count').innerText = wrongs.length;

                if(wrongs.length === 0) {
                    container.innerHTML = `
                        <div class="text-center py-20 bg-white rounded-2xl shadow-sm">
                            <i class="fa-solid fa-trophy text-6xl text-yellow-400 mb-4"></i>
                            <h3 class="text-2xl font-bold text-slate-800">All Caught Up!</h3>
                            <p class="text-slate-500">You have no wrong answers pending. Great job!</p>
                        </div>
                    `;
                    return;
                }

                container.innerHTML = '';
                wrongs.forEach((q, idx) => {
                    container.innerHTML += `
                        <div class="glass-panel p-6 rounded-xl shadow-sm border-l-4 border-red-500">
                            <div class="flex justify-between items-start mb-4">
                                <div>
                                    <span class="text-xs font-bold text-slate-400 uppercase tracking-wider">${q.subject}  ${q.chapter}</span>
                                    <h3 class="text-lg font-medium text-slate-800 mt-1">${q.text}</h3>
                                </div>
                                <span class="bg-red-100 text-red-700 text-xs font-bold px-2 py-1 rounded">WRONG</span>
                            </div>
                            
                            <div id="wrong-attempt-${idx}" class="space-y-2 mb-4">
                                ${q.options.map((opt, oIdx) => `
                                    <button onclick="app.attemptWrong(${idx}, ${oIdx})" class="w-full text-left p-3 rounded-lg border border-slate-200 hover:bg-slate-50 transition text-sm">
                                        <span class="font-bold mr-2">${String.fromCharCode(65+oIdx)}.</span> ${opt}
                                    </button>
                                `).join('')}
                            </div>

                            <div id="wrong-solution-${idx}" class="hidden bg-green-50 p-4 rounded-lg border border-green-100">
                                <div class="flex items-center mb-2 text-green-800 font-bold">
                                    <i class="fa-solid fa-check-circle mr-2"></i> Correct Answer: ${q.options[q.correct]}
                                </div>
                                <p class="text-sm text-slate-700">${q.explanation}</p>
                                <button onclick="app.removeWrong(${idx})" class="mt-3 text-xs bg-green-600 text-white px-3 py-1 rounded hover:bg-green-700 transition">
                                    Mark as Mastered & Remove
                                </button>
                            </div>
                        </div>
                    `;
                });
            },

            attemptWrong: (listIndex, optionIndex) => {
                const q = appState.userStats.wrongAttempts[listIndex];
                const solutionDiv = document.getElementById(`wrong-solution-${listIndex}`);
                const attemptDiv = document.getElementById(`wrong-attempt-${listIndex}`);
                
                if(optionIndex === q.correct) {
                    attemptDiv.innerHTML = `<div class="p-3 bg-green-100 text-green-700 rounded font-bold text-center">Correct! Here is the explanation:</div>`;
                    solutionDiv.classList.remove('hidden');
                } else {
                    const btns = attemptDiv.getElementsByTagName('button');
                    btns[optionIndex].classList.add('bg-red-100', 'border-red-300', 'text-red-700');
                    alert("Still incorrect. Try again or view solution.");
                }
            },

            removeWrong: (index) => {
                appState.userStats.wrongAttempts.splice(index, 1);
                app.saveStats();
                app.renderWrongAttempts();
            },

            // ==========================================
            // USER PROFILE MANAGEMENT (LOCALSTORAGE)
            // ==========================================
            
            createUser: () => {
                const name = document.getElementById('new-user-name').value.trim();
                const email = document.getElementById('new-user-email').value.trim();
                
                if (!name) {
                    alert('Please enter your name to continue');
                    document.getElementById('new-user-name').focus();
                    return;
                }
                
                const user = {
                    id: 'user_' + Date.now(),
                    name: name,
                    email: email || null,
                    createdAt: new Date().toISOString()
                };
                
                const users = app.getAllUsers();
                users.push(user);
                localStorage.setItem('neetAllUsers', JSON.stringify(users));
                
                app.loginUser(user);
            },
            
            loginUser: (user) => {
                app.currentUser = user;
                localStorage.setItem('neetCurrentUser', JSON.stringify(user));
                
                // Hide modal and enable site
                document.getElementById('login-modal').classList.remove('active');
                document.body.classList.add('logged-in');
                
                app.showUserProfile();
                app.loadUserStats();
                app.showToast(`Welcome back, ${user.name}!`, 'success');
            },
            
            getAllUsers: () => {
                const saved = localStorage.getItem('neetAllUsers');
                return saved ? JSON.parse(saved) : [];
            },
            
            renderExistingUsers: () => {
                const container = document.getElementById('existing-users');
                const section = document.getElementById('existing-users-section');
                const users = app.getAllUsers();
                
                if (users.length === 0) {
                    section.classList.add('hidden');
                    return;
                }
                
                section.classList.remove('hidden');
                container.innerHTML = users.map(u => `
                    <button onclick='app.loginUser(${JSON.stringify(u)})' 
                        class="w-full flex items-center gap-3 p-3 rounded-lg border border-slate-200 hover:border-teal-500 hover:bg-teal-50 transition text-left">
                        <div class="w-10 h-10 rounded-full bg-teal-100 text-teal-600 flex items-center justify-center font-bold">
                            ${u.name.charAt(0).toUpperCase()}
                        </div>
                        <div class="flex-1">
                            <p class="font-medium text-slate-800">${u.name}</p>
                            ${u.email ? `<p class="text-xs text-slate-500">${u.email}</p>` : ''}
                        </div>
                        <i class="fa-solid fa-arrow-right text-slate-400"></i>
                    </button>
                `).join('');
            },
            
            showUserProfile: () => {
                if (!app.currentUser) return;
                
                // Show in nav
                const navDisplay = document.getElementById('nav-user-display');
                if (navDisplay) {
                    navDisplay.classList.remove('hidden');
                    document.getElementById('nav-username').innerText = app.currentUser.name;
                    document.getElementById('nav-avatar').innerText = app.currentUser.name.charAt(0).toUpperCase();
                }
            },
            
            logout: () => {
                // Hide nav user display
                document.getElementById('nav-user-display').classList.add('hidden');
                app.currentUser = null;
                localStorage.removeItem('neetCurrentUser');
                
                // Show login modal again
                document.getElementById('login-modal').classList.add('active');
                document.body.classList.remove('logged-in');
                
                appState.userStats = {
                    totalAttempted: 0,
                    totalCorrect: 0,
                    wrongAttempts: [],
                    chapterProgress: {}
                };
                
                app.renderDashboard();
                app.showToast('Logged out', 'info');
            },
            
            showToast: (message, type = 'info') => {
                const toast = document.createElement('div');
                toast.className = `toast ${type}`;
                toast.innerText = message;
                document.body.appendChild(toast);
                setTimeout(() => toast.remove(), 3000);
            }
        };

        document.addEventListener('DOMContentLoaded', app.init);

    </script>
</body>
</html>
